#!/usr/bin/wish

## Interface for HS

package require Device 1.2
package require xBlt 3
package require Exp

### parameters

set par_list [list \
  name     {Main magnet} {program title}\
  ps_dev      ps0:1L {1st power supply device}\
  ps_dev2     ps0:2H {2nd power supply device}\
  gauge_dev   lockin0:FXY {measure device}\
  ovp           5   {overvoltage protection, V}\
  ramp_tstep  0.2   {ramping time step}\
  idle_tstep  0.2   {idle time step}\
  maxI          2   {max current, A}\
  minI          0   {off destination, A}\
  max_rate      0.1 {max rate, A/s}\
  def_rate     0.01 {default rate, A/s}\
  db       db_exp               {db device}\
  db_val   drydemag/sweep_main    {database for sweeper values}\
  db_ann   drydemag/sweep_main_a  {database for sweeper annotations}\
  db_cryo  drydemag/comments      {database for high-level comments}\
]



foreach {name def title} $par_list { set pars($name) $def }

set pars(db) ""

##########################################################
## control functions (one can use this from external scripts)

set current 0; ## current value
set resistance 0; ## resistance value
set X 0; ## current value
set Y 0; ## resistance value
set A 0; ## resistance value
set P 0; ## resistance value

set state 0;   ## does sweeper work
set rate $pars(def_rate);
set dest1 0;
set dest2 0;

proc get_current {} {
  return $::current
}

proc do_sweep {dest1 dest2 rate} {
  set ::dest1 $dest1
  set ::dest2 $dest2
  set ::rate $rate
  if {$::state == 0} {return}
  sweeper sweep_between $dest1 $dest2 $rate
}

proc do_go {dest rate} {
  set ::dest1 $dest
  set ::rate $rate
  if {$::state == 0} {return}
  sweeper sweep $dest $rate
}

proc do_stop {dest rate} {
  if {$::state == 0} {return}
  sweeper sweep_stop
}

proc do_reset {} {
  if {$::state == 0} {return}
  sweeper reset
}

proc do_onoff {state} {
  if {$state == 0} {
    sweeper turn_off
    .f.g.go configure -state disabled
    .f.g.sw configure -state disabled
    .f.g.st configure -state disabled
  }\
  else {
    sweeper turn_on
    .f.g.go configure -state normal
    .f.g.sw configure -state normal
    .f.g.st configure -state normal
  }
  set ::state $state
}

##########################################################
## function for Start/Stop/ToZero/Clear/Reset buttons

proc on_new_com {t com} {
  p add_comment $t $com
  return
}

## update values command
proc on_new_val {t cm cs vm {meas 0}} {
  global pars
  set ::resistance [expr { $cm>0? $vm/$cm:0} ]
  set ::current $cm
  set ::X [lindex $meas 1]
  set ::Y [lindex $meas 2]
  set ::A [expr hypot($::X,$::Y)]
  set ::P [expr atan2($::Y,$::X)]

  p add_data $t [list $::current $::A $::P $::X $::Y]

  .f.m.vI configure -text [format "%.3f" $::current]
  .f.m.vR configure -text [format "%.3f" $::resistance]

  return
}



##########################################################
## make interface

proc make_coil_control {root coil} {
  labelframe $root -padx 5 -pady 5

  frame $root.m;  # measure frame
  label $root.m.vI -font {-size 14 -weight bold}
  label $root.m.uI -text " A, " -font {-size 12}
  label $root.m.vR -font {-size 14 -weight bold}
  label $root.m.uR -text " Ohm " -font {-size 12}
  grid $root.m.vI $root.m.uI\
       $root.m.vR $root.m.uR -sticky w
  pack $root.m -fill x

  frame $root.g;  # go frame
  label $root.g.ldest1 -text "destination 1: " -padx 2 -pady 2
  entry $root.g.dest1  -width 10 -textvariable ::dest1
  label $root.g.udest1 -text "(A), "
  label $root.g.ldest2 -text "destination 2: " -padx 2 -pady 2
  entry $root.g.dest2  -width 10 -textvariable ::dest2
  label $root.g.udest2 -text "(A), "
  label $root.g.lrate -text "rate: " -padx 2 -pady 2
  entry $root.g.rate -width 6 -textvariable ::rate
  label $root.g.urate -text "(A/s) "
  button $root.g.go   -text "Goto 1" -pady 3 -bg #bdc1d4 -command {do_go $::dest1 $::rate} -state disabled
  button $root.g.sw   -text "Sweep between" -pady 3 -bg #bdc1d4 -command {do_sweep $::dest1 $::dest2 $::rate} -state disabled
  button $root.g.st   -text "Stop" -pady 3 -bg #bdc1d4 -command {do_stop $::dest1 $::dest2 $::rate} -state disabled
  grid $root.g.ldest1 $root.g.dest1 $root.g.udest1\
       $root.g.ldest2 $root.g.dest2 $root.g.udest2\
       $root.g.lrate $root.g.rate $root.g.urate\
       $root.g.go $root.g.sw $root.g.st -sticky w
  pack $root.g -fill x

  frame $root.b;  # button frame
  checkbutton $root.b.oo -text "on/off" -variable ::state -command {do_onoff $::state}
  grid $root.b.oo -sticky w
  pack $root.b -fill x
}


######################
# program title
frame .n
label .n.name   -text "$pars(name)" -font {-size 20}
pack .n.name -side left
pack .n -anchor w

######################
# buttons
make_coil_control .f grad
pack .f -anchor w -fill x -expand 0


blt::tabset .tabs -side top

######################
# make graph
TimePlot p .tabs.tplot\
   -ncols 5\
   -maxt 600\
   -colors {red magenta darkcyan green blue}\
   -titles {I Amp Ph X Y}\
   -names {I Amp Ph X Y }\
   -plots_x {time I X }\
   -plots_y {{} {} {Y}}\
   -hides {0 1 1 0 0}\
   -use_comm 1

######################
# parameter page
frame .tabs.pars
foreach {name def title} $par_list {
  label .tabs.pars.l:$name -text "$title:"
  label .tabs.pars.$name -text "$def" -font bold
  grid .tabs.pars.l:$name .tabs.pars.$name -sticky w
}

.tabs insert end plot -window .tabs.tplot\
   -anchor n -text "Time plot" -fill both
.tabs insert end pars -window .tabs.pars\
   -anchor n -text "Parameters" -fill both
pack .tabs -fill both -expand 1



##########################################################

update

## build sweeper object
SweepController sweeper\
  -ps_dev1    $pars(ps_dev)\
  -ps_dev2    $pars(ps_dev2)\
  -gauge      $pars(gauge_dev)\
  -db_dev     $pars(db)\
  -db_val     $pars(db_val)\
  -db_ann     $pars(db_ann)\
  -max_volt   $pars(ovp)\
  -max_rate   $pars(max_rate)\
  -ramp_tstep $pars(ramp_tstep)\
  -idle_tstep $pars(idle_tstep)\
  -on_new_val on_new_val\
  -on_new_com on_new_com
