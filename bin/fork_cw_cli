#!/usr/bin/wish

proc usage {} {
  puts {
    fork_cw_cli -- command line tool for controlling fork_cw interface

    Usage: sweeper_cli <name> <command>

    <name> name of the sweeper which is set in its configuration file
    <command>:
      set_volt <volt> -- set voltage
      get_volt -- get voltage
      sweep_pair [<volt>] -- set voltage, make 2 sweeps, wait

      set_ampsweep_max [<volt>] -- set max voltage for amp sweep
      get_ampsweep_max  -- get value
      set_ampsweep_step [<volt>] -- set step for amp sweep
      get_ampsweep_step  -- get value
      set_ampsweep_jump [0|1] -- set jump option for amp sweep
      get_ampsweep_jump  -- get value
      ampsweep_go  -- start amp sweep
  }
  exit 1
}

set name [lindex $argv 0]
set cmd  [lindex $argv 1]

if {$name == {}} usage
if {$cmd  == {}} usage

######################################################################
# Connect to a program and ask for its state

set app $name

if {$cmd == "set_volt"} {
  set v [lindex $argv 2]
  send $app {$gen} set_volt $v
  exit 0
}

if {$cmd == "get_volt"} {
  puts [send $app {$gen} get_volt]
  exit 0
}

# sweep_pair [volt]
if {$cmd == "sweep_pair"} {
  set v [lindex $argv 2]
  if {$v != {}} {send $app {$gen} set_volt $v}
  send $app sweep_pan set_mode "Pair"
  send $app sweep_pan restart
  send $app sweep_pan do_step
  while {[send $app sweep_pan is_on]} {
    after 200
  }
  exit 0
}

####

if {$cmd == "set_ampsweep_max"} {
  set v [lindex $argv 2]
  send $app set pars(track_amp_mx) $v
  exit 0
}

if {$cmd == "get_ampsweep_max"} {
  puts [send $app set pars(track_amp_mx)]
  exit 0
}

if {$cmd == "set_ampsweep_step"} {
  set v [lindex $argv 2]
  send $app set pars(track_amp_s) $v
  exit 0
}

if {$cmd == "get_ampsweep_step"} {
  puts [send $app set pars(track_amp_s)]
  exit 0
}

if {$cmd == "set_ampsweep_jump"} {
  set v [lindex $argv 2]
  send $app set pars(track_amp_j) $v
  exit 0
}

if {$cmd == "get_ampsweep_jump"} {
  puts [send $app set pars(track_amp_j)]
  exit 0
}

if {$cmd == "ampsweep_go"} {
  send $app on_track_ampsw
  exit 0
}


puts "Unknown command: $cmd"


######################################################################
wm withdraw .
after idle exit 0
